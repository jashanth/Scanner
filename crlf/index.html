<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delta - CRLF Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .sidebar {
            width: 80px;
            background-color: #1e293b;
            padding: 1.5rem 0;
            border-right: 2px solid #334155;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
        }

        .content-area {
            flex-grow: 1;
            padding: 2rem 3rem;
        }

        .card {
            background-color: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .form-input,
        .select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .select:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
        }

        .btn {
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: #0ea5e9;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0284c7;
        }

        .btn-secondary {
            background-color: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #525f77;
        }

        .btn:disabled {
            background-color: #475569;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .results-area {
            background-color: #152238;
            border-radius: 1rem;
            min-height: 40vh;
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
        }

        .results-area::-webkit-scrollbar {
            width: 8px;
        }

        .results-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .results-area::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }

        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0ea5e9;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(120%);
            animation: slideIn 0.5s forwards, slideOut 0.5s 3.5s forwards;
            z-index: 50;
        }

        @keyframes slideIn {
            from {
                transform: translateX(120%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(120%);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .checkbox-custom {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="sidebar">
        <a href="/dashboard" title="Back to Dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="40" height="40"
                aria-label="Radar scanner shield" class="flex-shrink-0">
                <!-- Shield background -->
                <path d="M32 5 L13 13 v15 c0 13 11 23 19 27 8-4 19-14 19-27V13L32 5z" fill="#071433" />
                <!-- shield glow outline -->
                <path d="M32 5 L13 13 v15 c0 13 11 23 19 27 8-4 19-14 19-27V13L32 5z" fill="none" stroke="#0ea5e9"
                    stroke-width="1.8" stroke-linejoin="round" opacity="0.95" />
                <!-- Radar rings -->
                <g transform="translate(32,30)" stroke="#60a5fa" stroke-width="1.2" fill="none">
                    <circle r="10" opacity="0.18" />
                    <circle r="6" opacity="0.28" />
                    <circle r="2.5" opacity="0.45" />
                </g>
                <!-- Sweeping beam: a rotated gradient sector animated -->
                <defs>
                    <linearGradient id="beamGrad" x1="0" x2="1">
                        <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.45" />
                        <stop offset="100%" stop-color="#60a5fa" stop-opacity="0.02" />
                    </linearGradient>
                    <mask id="beamMask">
                        <!-- full circle black -->
                        <rect width="64" height="64" fill="white" />
                        <!-- clear shield center so beam shows only inside shield -->
                        <path d="M32 5 L13 13 v15 c0 13 11 23 19 27 8-4 19-14 19-27V13L32 5z" fill="black" />
                    </mask>
                </defs>
                <!-- beam (a wide triangle) placed over center -->
                <g transform="translate(0,0)" mask="url(#beamMask)">
                    <g transform="translate(32,30)">
                        <path d="M0 0 L28 -12 A28 28 0 0 1 28 12 Z" fill="url(#beamGrad)" opacity="0.9">
                            <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="3.2s"
                                repeatCount="indefinite" />
                        </path>
                    </g>
                </g>
                <!-- sweep hand (thin) with pulse at tip -->
                <g transform="translate(32,30)">
                    <line x1="0" y1="0" x2="26" y2="-11" stroke="#38bdf8" stroke-width="1.6" stroke-linecap="round"
                        opacity="0.9">
                        <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="3.2s"
                            repeatCount="indefinite" />
                    </line>
                    <circle cx="26" cy="-11" r="2.5" fill="#38bdf8">
                        <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="3.2s"
                            repeatCount="indefinite" />
                        <animate attributeName="r" values="1.6;2.8;1.6" dur="3.2s" repeatCount="indefinite" />
                        <animate attributeName="opacity" values="0.9;0.6;0.9" dur="3.2s" repeatCount="indefinite" />
                    </circle>
                </g>
            </svg>
        </a>
    </aside>

    <!-- Main Content -->
    <main class="content-area w-full">
        <header class="flex flex-wrap items-center justify-between gap-4 mb-8 pb-4 border-b-2 border-slate-700">
            <div>
                <h1 class="text-3xl font-bold">CRLF Injection Tester</h1>
                <p class="text-slate-400 mt-1">Detect header injection vulnerabilities by testing CRLF payloads.</p>
            </div>
            <a href="/dashboard"
                class="btn bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-xl transition-colors">Back
                to Dashboard</a>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Input and Controls -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card">
                    <div>
                        <label for="urlInput" class="block text-lg font-medium text-slate-300 mb-2">Target URL</label>
                        <input type="url" id="urlInput" placeholder="http://example.com/page.php?file="
                            class="form-input">
                        <p class="text-xs text-slate-500 mt-2">Include the parameter to test (e.g., `?file=`).</p>
                    </div>
                    <div class="mt-4">
                        <label for="targetSelect" class="block text-sm font-medium text-slate-400 mb-2">Load Saved
                            Target</label>
                        <select id="targetSelect" class="select">
                            <option value="">-- Select a saved target --</option>
                        </select>
                    </div>
                    <div class="mt-4">
                        <label for="timeoutInput" class="block text-sm font-medium text-slate-400 mb-2">Timeout
                            (seconds)</label>
                        <input type="number" id="timeoutInput" value="8" min="1" max="60" class="form-input">
                    </div>
                    <div class="mt-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="confirmChk" class="checkbox-custom">
                            <span class="text-sm text-slate-400">I have permission to test this target (required)</span>
                        </label>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button id="scanBtn" class="btn btn-primary w-full text-base">
                            <svg id="scanner-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                </path>
                            </svg>
                            <span id="scanBtnText">Run CRLF Tests</span>
                            <svg id="scanner-spinner" class="animate-spin h-5 w-5 text-white hidden"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </button>
                        <button id="saveTargetBtn" class="btn btn-secondary" title="Save current target">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <button id="exportBtn" class="btn btn-secondary w-full text-base mt-4 hidden">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Export Results
                    </button>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                <div class="card mb-4">
                    <h2 class="text-xl font-semibold text-slate-200">Summary</h2>
                    <div id="summary" class="mt-3 text-sm text-slate-400">No test run yet.</div>
                </div>
                <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                    <h2 class="text-2xl font-semibold text-slate-200">Test Results</h2>
                    <div id="results-summary" class="text-sm font-medium text-slate-400"></div>
                </div>
                <div id="results" class="results-area">
                    <div class="flex items-center justify-center h-full">
                        <p class="text-slate-500">Results will be displayed here...</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="toast-container"></div>
    </main>

    <script>
        // --- DOM Elements ---
        const urlInput = document.getElementById("urlInput");
        const targetSelect = document.getElementById("targetSelect");
        const timeoutInput = document.getElementById("timeoutInput");
        const confirmChk = document.getElementById("confirmChk");
        const scanBtn = document.getElementById("scanBtn");
        const scanBtnText = document.getElementById("scanBtnText");
        const scannerIcon = document.getElementById("scanner-icon");
        const spinner = document.getElementById("scanner-spinner");
        const saveTargetBtn = document.getElementById("saveTargetBtn");
        const exportBtn = document.getElementById("exportBtn");
        const summaryDiv = document.getElementById("summary");
        const resultsDiv = document.getElementById("results");
        const resultsSummary = document.getElementById("results-summary");
        const toastContainer = document.getElementById("toast-container");

        let lastData = null;

        // --- State Management ---
        function setScanningState(isScanning) {
            urlInput.disabled = isScanning;
            targetSelect.disabled = isScanning;
            timeoutInput.disabled = isScanning;
            confirmChk.disabled = isScanning;
            scanBtn.disabled = isScanning;
            saveTargetBtn.disabled = isScanning;
            scannerIcon.classList.toggle('hidden', isScanning);
            scanBtnText.textContent = isScanning ? 'Testing...' : 'Run CRLF Tests';
            spinner.classList.toggle('hidden', !isScanning);
            if (isScanning) {
                resultsSummary.textContent = '';
                exportBtn.classList.add('hidden');
            }
        }

        // --- UI Helpers ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function escapeHtml(unsafe) {
            return unsafe ? unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : '';
        }

        // --- Local Storage (Targets) ---
        function loadTargetsToSelect() {
            const targets = JSON.parse(localStorage.getItem("deltaAppTargets")) || [];
            targetSelect.innerHTML = `<option value="">-- Select a saved target --</option>`;
            targets.forEach(target => {
                const option = document.createElement("option");
                option.value = target;
                option.textContent = target;
                targetSelect.appendChild(option);
            });
        }

        saveTargetBtn.addEventListener("click", () => {
            const urlToSave = urlInput.value.trim();
            if (!urlToSave) {
                showToast("Error: URL input is empty.");
                return;
            }
            let targets = JSON.parse(localStorage.getItem("deltaAppTargets")) || [];
            if (!targets.includes(urlToSave)) {
                targets.unshift(urlToSave);
                localStorage.setItem("crlfTargets", JSON.stringify(targets.slice(0, 50)));
                loadTargetsToSelect();
                showToast("Target saved successfully!");
            } else {
                showToast("This target is already saved.");
            }
        });

        targetSelect.addEventListener("change", (e) => {
            if (e.target.value) urlInput.value = e.target.value;
        });

        // --- Testing Logic ---
        scanBtn.addEventListener("click", async () => {
            const url = urlInput.value.trim();
            const confirm = confirmChk.checked;
            const timeout = Number(timeoutInput.value) || 8;

            if (!confirm) {
                summaryDiv.innerHTML = `<div class="p-3 bg-red-900/50 text-red-300 rounded-lg border border-red-700">You must confirm you have permission to test this target.</div>`;
                return;
            }

            if (!url || !url.includes('=')) {
                summaryDiv.innerHTML = `<div class="p-3 bg-red-900/50 text-red-300 rounded-lg border border-red-700">Provide a target URL with a parameter position (e.g., ?file=).</div>`;
                return;
            }

            setScanningState(true);
            resultsDiv.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-slate-400">Running CRLF tests...</p></div>';
            summaryDiv.innerHTML = '<p class="text-slate-400">Testing in progress...</p>';

            try {
                const res = await fetch('/api/crlf/crlf-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, confirm: true, timeout })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                lastData = data;

                // Summary
                const positiveColor = data.positives_count > 0 ? 'text-red-400' : 'text-green-400';
                summaryDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-3 text-sm animate-fade-in">
                    <div><span class="text-slate-400">Run ID:</span> <span class="font-semibold text-slate-200">${escapeHtml(data.run_id)}</span></div>
                    <div><span class="text-slate-400">Tag:</span> <span class="font-semibold text-slate-200">${escapeHtml(data.tag)}</span></div>
                    <div><span class="text-slate-400">Target:</span> <span class="font-semibold text-slate-200">${escapeHtml(data.target)}</span></div>
                    <div><span class="text-slate-400">Positives:</span> <span class="font-bold ${positiveColor}">${data.positives_count}</span> / ${data.results_count}</div>
                </div>
            `;

                // Update results summary
                if (data.positives_count > 0) {
                    resultsSummary.innerHTML = `<span class="text-red-400 font-semibold">ðŸ”´ ${data.positives_count} vulnerable</span>`;
                } else {
                    resultsSummary.innerHTML = `<span class="text-green-400 font-semibold">ðŸŸ¢ No vulnerabilities</span>`;
                }

                // Results listing
                resultsDiv.innerHTML = '';
                if (data.positives_count && data.positives_count > 0) {
                    data.positives.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-3 rounded-lg border border-red-800 bg-red-900/30 mt-2 animate-fade-in';

                        const foundHeaders = p.found_headers && p.found_headers.length
                            ? p.found_headers.map(f => `<div class="text-xs"><code>${escapeHtml(f.header)}: ${escapeHtml(f.value)}</code></div>`).join('')
                            : '<div class="text-xs text-slate-500">None detected</div>';

                        const bodySnippet = p.body_snippet
                            ? `<details class="mt-2"><summary class="cursor-pointer text-xs text-slate-400">Body snippet</summary><pre class="text-xs mt-1 p-2 bg-slate-900/50 rounded overflow-x-auto">${escapeHtml(p.body_snippet)}</pre></details>`
                            : '';

                        const headersJson = `<details class="mt-2"><summary class="cursor-pointer text-xs text-slate-400">Response headers</summary><pre class="text-xs mt-1 p-2 bg-slate-900/50 rounded overflow-x-auto">${escapeHtml(JSON.stringify(p.headers, null, 2))}</pre></details>`;

                        div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-medium"><b>Payload:</b> <code class="bg-slate-700/50 text-slate-300 px-1.5 py-0.5 rounded text-xs">${escapeHtml(p.payload)}</code></p>
                            <span class="text-red-400 font-bold text-sm">ðŸ”´ VULNERABLE</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-1"><b>URL:</b> <a href="${escapeHtml(p.test_url)}" target="_blank" class="text-blue-400 underline break-all">${escapeHtml(p.test_url)}</a></p>
                        <p class="text-xs text-slate-400 mt-1"><b>Status Code:</b> ${escapeHtml(String(p.status_code || 'error'))}</p>
                        <div class="mt-2"><b class="text-xs text-slate-300">Injected Headers:</b>${foundHeaders}</div>
                        ${bodySnippet}
                        ${headersJson}
                    `;
                        resultsDiv.appendChild(div);
                    });
                } else {
                    resultsDiv.innerHTML = `<div class="p-3 bg-green-900/30 border border-green-800 rounded-lg text-center mb-3"><p class="text-green-400 font-semibold">No positives found. Showing all test attempts below.</p></div>`;
                    data.all_results.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-3 rounded-lg border border-slate-700 bg-slate-800/30 mt-2 animate-fade-in';

                        const bodySnippet = p.body_snippet
                            ? `<details class="mt-2"><summary class="cursor-pointer text-xs text-slate-400">Body snippet</summary><pre class="text-xs mt-1 p-2 bg-slate-900/50 rounded overflow-x-auto">${escapeHtml(p.body_snippet)}</pre></details>`
                            : '';

                        const headersJson = `<details class="mt-2"><summary class="cursor-pointer text-xs text-slate-400">Response headers</summary><pre class="text-xs mt-1 p-2 bg-slate-900/50 rounded overflow-x-auto">${escapeHtml(JSON.stringify(p.headers || {}, null, 2))}</pre></details>`;

                        div.innerHTML = `
                        <p class="font-medium text-sm"><b>Payload:</b> <code class="bg-slate-700/50 text-slate-300 px-1.5 py-0.5 rounded text-xs">${escapeHtml(p.payload)}</code></p>
                        <p class="text-xs text-slate-400 mt-1"><b>URL:</b> <a href="${escapeHtml(p.test_url)}" target="_blank" class="text-blue-400 underline break-all">${escapeHtml(p.test_url)}</a></p>
                        <p class="text-xs text-slate-400 mt-1"><b>Status Code:</b> ${escapeHtml(String(p.status_code || 'error'))}</p>
                        ${bodySnippet}
                        ${headersJson}
                    `;
                        resultsDiv.appendChild(div);
                    });
                }

                exportBtn.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                summaryDiv.innerHTML = `<div class="p-3 bg-red-900/50 text-red-300 rounded-lg border border-red-700">Error: ${escapeHtml(err.message)}</div>`;
                resultsDiv.innerHTML = '';
            } finally {
                setScanningState(false);
            }
        });

        // --- Export Results ---
        exportBtn.addEventListener("click", () => {
            if (!lastData) return;

            let txt = "Delta CRLF Injection Test Results\n";
            txt += "==================================\n\n";
            txt += `Run ID: ${lastData.run_id}\n`;
            txt += `Tag: ${lastData.tag}\n`;
            txt += `Target: ${lastData.target}\n`;
            txt += `Positives: ${lastData.positives_count} / ${lastData.results_count}\n\n`;

            if (lastData.positives_count > 0) {
                txt += "VULNERABLE PAYLOADS:\n";
                txt += "====================\n\n";
                lastData.positives.forEach(p => {
                    txt += `Payload: ${p.payload}\n`;
                    txt += `URL: ${p.test_url}\n`;
                    txt += `Status: ${p.status_code}\n`;
                    if (p.found_headers && p.found_headers.length) {
                        txt += `Injected Headers:\n`;
                        p.found_headers.forEach(h => {
                            txt += `  ${h.header}: ${h.value}\n`;
                        });
                    }
                    txt += "\n";
                });
            } else {
                txt += "No vulnerabilities detected.\n";
            }

            const blob = new Blob([txt], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "crlf_test_results.txt";
            link.click();

            showToast("Results exported successfully!");
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTargetsToSelect();
        });
    </script>
</body>

</html>